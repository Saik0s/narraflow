<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    // Initialize store before Alpine loads
    window.alpineStore = {
      theme: localStorage.getItem('theme') || 'dark',
      init() {
        document.documentElement.setAttribute('data-theme', this.theme);
        document.body.setAttribute('data-theme', this.theme);
      }
    };
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Story</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Add type="module" to enable ES6 modules -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script type="module" src="{{ url_for('static', path='js/app.js') }}"></script>
  <!-- Add this line after the other CSS links -->
  <link href="{{ url_for('static', path='css/styles.css') }}" rel="stylesheet">
</head>

<body data-theme="dark" 
      class="min-h-screen bg-base-100" 
      x-data="{ 
        theme: window.alpineStore.theme,
        init() {
          window.alpineStore.init();
        }
      }">
  <div class="container mx-auto p-4 flex flex-col gap-4 h-screen max-h-screen">
    <div class="navbar bg-base-200 rounded-box shadow-lg">
      <div class="flex-1">
        <button id="clear-history" class="btn btn-ghost">Clear History</button>
      </div>
      <div class="flex-none">
        <!-- Add divider -->
        <div class="divider divider-horizontal"></div>

        <!-- Image Controls -->
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost m-1">
            <i class="fas fa-image"></i>
            <span class="ml-2">Image Settings</span>
          </label>
          <div tabindex="0" class="dropdown-content z-[1] menu p-4 shadow bg-base-200 rounded-box w-72">
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-4">
                <input type="checkbox" id="image-gen-enabled" class="checkbox checkbox-primary" checked />
                <span class="label-text">Enable Image Generation</span>
              </label>
            </div>
            <select id="image-gen-mode" class="select select-bordered w-full mt-2">
              <option value="after_chat">After Each Chat</option>
              <option value="periodic">Periodic</option>
            </select>
            <div id="interval-setting" class="form-control mt-2" style="display: none;">
              <label class="input-group">
                <input type="number" id="interval-input" min="5" value="30" class="input input-bordered w-20" />
                <span>seconds</span>
              </label>
            </div>
          </div>
        </div>

        <div class="divider divider-horizontal"></div>

        <!-- Theme toggle -->
        <label class="swap swap-rotate">
          <input type="checkbox" 
                 class="theme-controller" 
                 x-model="theme"
                 :checked="theme === 'dark'"
                 @change="
                   theme = $event.target.checked ? 'dark' : 'light';
                   document.documentElement.setAttribute('data-theme', theme);
                   document.body.setAttribute('data-theme', theme);
                   localStorage.setItem('theme', theme);
                 " />

          <!-- sun icon -->
          <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
          </svg>

          <!-- moon icon -->
          <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
          </svg>
        </label>
      </div>
    </div>

    <!-- Main Content -->
    <div class="card bg-base-200 shadow-xl flex-1 min-h-0 overflow-hidden">
      <div class="card-body h-full p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
          <!-- Chat Column -->
          <div class="bg-base-100 rounded-lg p-4 h-full flex flex-col overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Chat History</h2>
            <div id="chat-messages" class="flex-1 min-h-0 pb-4">
              <!-- Chat messages will be inserted here -->
            </div>
          </div>

          <!-- Images Column -->
          <div class="bg-base-100 rounded-lg p-4 h-full flex flex-col overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Story Visualization</h2>
            <div id="images-container" class="carousel carousel-vertical rounded-box flex-1 min-h-0">
              <!-- Images will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Panel -->
    <div class="bg-base-200 rounded-box shadow-lg p-4">
      <div id="keywords" class="flex flex-wrap gap-2 mb-4 min-h-[50px] bg-base-100 rounded-lg p-2">
      </div>
      <div class="flex flex-col gap-2">
        <div id="author-selector" class="join w-full mb-2">
          <!-- Content will be loaded via JavaScript -->
        </div>
        <form id="chat-form" 
              class="flex gap-2" 
              x-data="{ 
                message: '',
                isProcessing: false,
                selectedKeywords: [],
                chatHistory: [],
                imageHistory: [],
                keywords: [],
                
                init() {
                  this.loadState();
                  this.setupImageControls();
                  this.setupAuthorSelector();
                  this.renderMessages();
                  this.renderKeywords();
                  this.renderImages();
                },

                loadState() {
                  const state = localStorage.getItem('appState');
                  if (state) {
                    const parsed = JSON.parse(state);
                    this.chatHistory = parsed.chatHistory || [];
                    this.imageHistory = parsed.imageHistory || [];
                    this.keywords = parsed.keywords || [];
                    this.selectedKeywords = parsed.selectedKeywords || [];
                  }
                },

                saveState() {
                  localStorage.setItem('appState', JSON.stringify({
                    chatHistory: this.chatHistory,
                    imageHistory: this.imageHistory,
                    keywords: this.keywords,
                    selectedKeywords: this.selectedKeywords
                  }));
                },

                isValid() {
                  return this.message.trim() || this.selectedKeywords.length > 0;
                },

                async handleSendMessage() {
                  if (!this.isValid() || this.isProcessing) return;
                  
                  try {
                    this.isProcessing = true;
                    const response = await sendMessage(
                      this.message,
                      $store.app?.selectedAuthor || '',
                      this.chatHistory,
                      this.selectedKeywords
                    );

                    if (response?.llm_response) {
                      this.chatHistory.push(...response.llm_response.messages);
                      this.keywords = response.llm_response.keywords;
                      this.selectedKeywords = [];
                      this.message = '';
                      this.saveState();
                      this.renderMessages();
                      this.renderKeywords();
                      
                      if ($store.app?.imageSettings?.enabled &&
                          $store.app?.imageSettings?.mode === 'after_chat') {
                        await this.handleImageGeneration();
                      }
                    }
                  } catch (error) {
                    console.error('Failed to send message:', error);
                    this.showError('Failed to send message');
                  } finally {
                    this.isProcessing = false;
                  }
                },

                async handleImageGeneration() {
                  if (!$store.app?.imageSettings?.enabled ||
                      Date.now() - $store.app?.lastImageGeneration < 5000) {
                    return;
                  }

                  try {
                    const response = await generateImage(this.chatHistory);
                    if (response?.image_url) {
                      this.imageHistory.push(response.image_url);
                      $store.app.lastImageGeneration = Date.now();
                      this.saveState();
                      this.renderImages();
                    }
                  } catch (error) {
                    this.showError('Failed to generate image');
                  }
                },

                renderMessages() {
                  const container = document.getElementById('chat-messages');
                  if (!container) return;

                  container.innerHTML = '';
                  this.chatHistory.forEach((message, index) => {
                    const messageEl = this.createMessageElement(message, index);
                    container.appendChild(messageEl);
                  });

                  container.scrollTop = container.scrollHeight;
                },

                createMessageElement(message, index) {
                  const wrapper = document.createElement('div');
                  wrapper.className = message.author.toLowerCase() === 'user' ? 'chat chat-end' : 'chat chat-start';
                  wrapper.dataset.id = index;

                  const header = document.createElement('div');
                  header.className = 'chat-header text-xs text-base-content/40';
                  header.textContent = message.author;

                  const bubble = document.createElement('div');
                  bubble.className = `chat-bubble ${this.getAuthorColorClass(message.author)}`;
                  bubble.textContent = message.content;

                  wrapper.appendChild(header);
                  wrapper.appendChild(bubble);
                  return wrapper;
                },

                getAuthorColorClass(author) {
                  switch (author.toLowerCase()) {
                    case 'thoughts':
                    case 'system':
                    case 'narrator':
                      return 'bg-base/5 text-base-content/50';
                    default:
                      const hash = author.split('').reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0);
                      const hue = hash % 360;
                      return `bg-[hsl(${hue},10%,20%)] text-[hsl(${hue},60%,80%)]`;
                  }
                },

                renderKeywords() {
                  const container = document.getElementById('keywords');
                  if (!container) return;

                  container.innerHTML = '';
                  this.keywords.forEach(keyword => {
                    const keywordEl = this.createKeywordElement(keyword);
                    container.appendChild(keywordEl);
                  });
                },

                createKeywordElement(keyword) {
                  const wrapper = document.createElement('div');
                  wrapper.className = 'form-control';

                  const label = document.createElement('label');
                  label.className = 'label cursor-pointer gap-2 bg-base-200 rounded-full px-4 py-2 hover:bg-base-300 transition-colors';

                  const span = document.createElement('span');
                  span.className = `label-text text-${keyword.category}`;
                  span.textContent = keyword.text;

                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.className = 'checkbox checkbox-sm checkbox-primary';
                  checkbox.checked = this.selectedKeywords.includes(keyword.text);
                  checkbox.addEventListener('change', () => this.toggleKeyword(keyword.text));

                  label.appendChild(span);
                  label.appendChild(checkbox);
                  wrapper.appendChild(label);
                  return wrapper;
                },

                toggleKeyword(keyword) {
                  const index = this.selectedKeywords.indexOf(keyword);
                  if (index === -1) {
                    this.selectedKeywords.push(keyword);
                  } else {
                    this.selectedKeywords.splice(index, 1);
                  }
                  this.saveState();
                },

                showError(message) {
                  const notification = document.createElement('div');
                  notification.className = 'toast toast-top toast-end';
                  notification.innerHTML = `
                    <div class="alert alert-error">
                      <span>${message}</span>
                    </div>
                  `;
                  document.body.appendChild(notification);
                  // Ensure notification is removed even if user navigates away
                  const timeoutId = setTimeout(() => {
                    if (document.body.contains(notification)) {
                      notification.remove();
                    }
                  }, 3000);
                  // Clean up timeout if notification is removed early
                  notification.addEventListener('click', () => {
                    clearTimeout(timeoutId);
                    notification.remove();
                  });
                }
              }"
              @submit.prevent="handleSendMessage()">
          <input type="text" 
                 x-model="message"
                 placeholder="Type your message..." 
                 class="input input-bordered flex-1"
                 @keydown.enter.prevent="handleSendMessage">
          <button type="submit" 
                  class="btn btn-primary"
                  :disabled="!isValid() || isProcessing"
                  x-text="isProcessing ? 'Processing...' : 'Send'">
          </button>
        </form>
      </div>
    </div>
  </div>
</body>

</html>
