<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    // Initialize store before Alpine loads
    window.alpineStore = {
      theme: localStorage.getItem('theme') || 'dark',
      init() {
        document.documentElement.setAttribute('data-theme', this.theme);
        document.body.setAttribute('data-theme', this.theme);
      }
    };
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Story</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.13/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load app.js first -->
  <script type="module" src="{{ url_for('static', path='js/app.js') }}"></script>
  <!-- Then load Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Add this line after the other CSS links -->
  <link href="{{ url_for('static', path='css/styles.css') }}" rel="stylesheet">
</head>

<body data-theme="dark" class="min-h-screen bg-base-100" x-data="{}">
  <div class="container mx-auto p-4 flex flex-col gap-4 h-screen max-h-screen">
    <div class="navbar bg-base-200 rounded-box shadow-lg">
      <div class="flex-1">
        <button id="clear-history" class="btn btn-ghost" @click="$store.app.clearState()">Clear History</button>
      </div>
      <div class="flex-none">
        <!-- Add divider -->
        <div class="divider divider-horizontal"></div>

        <!-- Image Controls -->
        <div class="flex items-center space-x-4" x-data>
          <label class="flex items-center space-x-2">
            <input type="checkbox" x-model="$store.app.imageSettings.enabled" @change="$store.app.toggleImageGeneration()" class="checkbox checkbox-primary" />
            <span class="label-text">Enable Image Generation</span>
          </label>

          <select x-model="$store.app.imageSettings.mode" @change="$store.app.toggleImageGeneration()" class="select select-bordered">
            <option value="after_chat">After Each Chat</option>
            <option value="periodic">Periodic</option>
          </select>

          <div x-show="$store.app.imageSettings.mode === 'periodic'" class="form-control">
            <label class="input-group">
              <input type="number" x-model.number="$store.app.imageSettings.interval_seconds" @input="$store.app.toggleImageGeneration()" min="5" class="input input-bordered w-20" />
              <span>seconds</span>
            </label>
          </div>
        </div>

        <div class="divider divider-horizontal"></div>

        <!-- Config button -->
        <button class="btn btn-ghost" @click="$store.app.openConfig()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Configure
        </button>

        <div class="divider divider-horizontal"></div>

        <!-- Theme toggle -->
        <label class="swap swap-rotate">
          <input type="checkbox" class="theme-controller" x-model="$store.app.theme" :checked="$store.app.theme === 'dark'" @change="
                   $store.app.theme = $event.target.checked ? 'dark' : 'light';
                   document.documentElement.setAttribute('data-theme', $store.app.theme);
                   document.body.setAttribute('data-theme', $store.app.theme);
                   localStorage.setItem('theme', $store.app.theme);
                 " />

          <!-- sun icon -->
          <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
          </svg>

          <!-- moon icon -->
          <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
          </svg>
        </label>
      </div>
    </div>

    <!-- Main Content -->
    <div class="card bg-base-200 shadow-xl flex-1 min-h-0 overflow-hidden">
      <div class="card-body h-full p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
          <!-- Chat Column -->
          <div class="bg-base-100 rounded-lg p-4 h-full flex flex-col overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Chat History</h2>
            <div id="chat-messages" class="flex-1 min-h-0 pb-4"
                 x-effect="$nextTick(() => {
                   const container = document.getElementById('chat-messages');
                   container.scrollTop = container.scrollHeight;
                 })">
              <template x-for="(message, index) in $store.app.chatHistory" :key="index">
                <div :class="['system', 'narrator', 'thoughts'].includes(message.author.toLowerCase()) ? 'chat chat-end' : 'chat chat-start'" :data-id="index">
                  <div class="chat-header text-xs text-base-content/40" x-text="message.author"></div>
                  <div :class="`chat-bubble ${$store.app.getAuthorColorClass(message.author)}`" x-text="message.content"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- Images Column -->
          <div class="bg-base-100 rounded-lg p-4 h-full flex flex-col overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Story Visualization</h2>
            <div id="images-container"
                 class="carousel carousel-vertical rounded-box flex-1 min-h-0"
                 x-effect="$nextTick(() => {
                   const container = document.getElementById('images-container');
                   const prevCount = container.dataset.imageCount || 0;
                   const currentCount = $store.app.imageHistory.length;

                   if (currentCount > prevCount) {
                     container.scrollTop = container.scrollHeight;
                   }

                   container.dataset.imageCount = currentCount;
                   $store.app.lazyLoadImages();
                 })">
              <template x-for="(imageUrl, index) in $store.app.imageHistory" :key="index">
                <div class="carousel-item h-auto w-full">
                  <img :data-src="imageUrl" class="rounded-box lazy">
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Panel -->
    <div class="bg-base-200 rounded-box shadow-lg p-4">
      <div id="keywords" class="flex flex-wrap gap-2 mb-4 min-h-[50px] bg-base-100 rounded-lg p-2">
        <template x-for="keyword in $store.app.keywords" :key="keyword.text">
          <div class="form-control">
            <label class="label cursor-pointer gap-2 bg-base-200 rounded-full px-4 py-2 hover:bg-base-300 transition-colors">
              <span :class="`label-text text-${keyword.category}`" x-text="keyword.text"></span>
              <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" :checked="$store.app.selectedKeywords.includes(keyword.text)"
                @change="$store.app.toggleKeyword(keyword.text)">
            </label>
          </div>
        </template>
      </div>
      <div class="flex flex-col gap-2">
        <div id="author-selector" class="join w-full mb-2">
          <!-- Content will be loaded via JavaScript -->
        </div>
        <form id="chat-form" class="flex gap-2" @submit.prevent="$store.app.handleSendMessage()">
          <input type="text" x-model="$store.app.currentInput" placeholder="Type your message..." class="input input-bordered flex-1"
            @keydown.enter.prevent="$store.app.handleSendMessage()">
          <button type="submit" class="btn btn-primary" :disabled="!$store.app.isMessageValid() || $store.app.isProcessing"
            x-text="$store.app.isProcessing ? 'Processing...' : 'Send'"></button>
        </form>
      </div>
    </div>
  </div>

  <!-- Configuration Modal -->
  <div x-show="$store.app.showConfigModal"
       class="modal modal-open"
       @click.self="$store.app.closeConfig()">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">System Configuration</h3>

      <div class="form-control gap-4">
        <div>
          <label class="label">
            <span class="label-text">Storyteller System Prompt</span>
          </label>
          <textarea
            x-model="$store.app.config.storytellerPrompt"
            class="textarea textarea-bordered h-24 w-full"
            placeholder="Enter system prompt for the storyteller..."></textarea>
        </div>

        <div>
          <label class="label">
            <span class="label-text">Image Generator System Prompt</span>
          </label>
          <textarea
            x-model="$store.app.config.imagePrompt"
            class="textarea textarea-bordered h-24 w-full"
            placeholder="Enter system prompt for the image generator..."></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-primary" @click="$store.app.saveConfig()">Save</button>
        <button class="btn" @click="$store.app.closeConfig()">Cancel</button>
      </div>
    </div>
  </div>
</body>

</html>
